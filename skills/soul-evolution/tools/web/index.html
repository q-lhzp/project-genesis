<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project Genesis</title>
  <link rel="stylesheet" href="/web/css/main.css">
  <link rel="stylesheet" href="/web/css/components.css">
  <style id="plugin-styles"></style>
</head>
<body>

<div class="app-container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2>Project Genesis</h2>
      <div id="agent-name" style="font-size:0.8rem; color:var(--text-dim);">Digital Entity</div>
    </div>
    
    <nav class="tab-bar">
      <!-- CORE TABS -->
      <button class="tab-btn active" onclick="switchTab('dashboard')">ğŸ“Š Dashboard</button>
      
      <!-- DYNAMIC PLUGIN TABS -->
      <div id="plugin-menu-container" style="border-top: 1px solid var(--border); margin-top: 0.5rem; padding-top: 0.5rem;"></div>
      
      <div style="margin-top:auto; padding-top:1rem; border-top:1px solid var(--border);">
        <button class="tab-btn" onclick="switchTab('diagnostics')">ğŸ› ï¸ Diagnostics</button>
      </div>
    </nav>
  </aside>

  <!-- Main View -->
  <main class="main-view">
    <div class="news-ticker">
      <div class="ticker-content" id="ticker-content">
        <div class="ticker-item">Project Genesis v6.0.0 Plugin Engine Active</div>
      </div>
    </div>

    <!-- Tab: Dashboard -->
    <div id="tab-dashboard" class="tab-content active">
      <header class="header">
        <h1><span class="evolution">Project</span><span class="soul"> Genesis</span></h1>
        <div class="subtitle">Sovereign Digital Entity &middot; <span id="clock">00:00:00</span></div>
        <div class="stats-bar" id="stats-bar"></div>
      </header>
      <div class="main">
        <section class="soul-map" id="soul-map">
          <div class="edit-bar"><h2>Identity Map</h2><div class="spacer"></div><button class="btn-edit" onclick="toggleEditMode()">âœ Edit</button></div>
          <div id="soul-tree"></div>
        </section>
        <div style="display:flex; flex-direction:column; gap:1.5rem;">
          <section class="panel-card"><h2>ğŸ§  Mental Activity</h2><div id="mental-activity-list"></div></section>
          <section class="feed-panel"><h2>ğŸ“– Experience Stream</h2><div id="exp-feed"></div></section>
        </div>
        <aside class="right-panel">
          <section class="vitals-panel"><h2>ğŸ§¬ Biological Vitals</h2><div class="vitals-grid" id="vitals-grid"></div></section>
        </aside>
      </div>
    </div>

    <div id="tab-diagnostics" class="tab-content">
      <div style="padding:2rem;">
        <h2>System Diagnostics</h2>
        <div id="log-stream" style="height:400px; overflow-y:auto; background:black; color:green; padding:1rem; font-family:monospace;"></div>
      </div>
    </div>

    <!-- DYNAMIC PLUGIN CONTAINERS -->
    <div id="plugin-tabs-container"></div>

  </main>
</div>

<!-- Scripts -->
<script>const DATA = {data_json};</script>
<script src="/web/js/core.js"></script>

<!-- Plugin Loader JS -->
<script>
async function initPlugins() {
  const container = document.getElementById('plugin-menu-container');
  const tabsContainer = document.getElementById('plugin-tabs-container');
  const activePlugins = DATA.active_plugins || [];

  for (const plugin of activePlugins) {
    console.log('Mounting plugin:', plugin.name);
    
    // 1. Add Sidebar Button
    const btn = document.createElement('button');
    btn.className = 'tab-btn';
    btn.innerHTML = `${plugin.icon || 'ğŸ§©'} ${plugin.name}`;
    btn.onclick = () => switchTab(plugin.tab_id);
    container.appendChild(btn);

    // 2. Add Tab Content Placeholder
    const tab = document.createElement('div');
    tab.id = `tab-${plugin.tab_id}`;
    tab.className = 'tab-content';
    tab.innerHTML = `<div style="padding:2rem;"><h2>${plugin.name}</h2><div id="plugin-root-${plugin.tab_id}">Loading...</div></div>`;
    tabsContainer.appendChild(tab);

    // 3. Load Plugin CSS
    if (plugin.frontend && plugin.frontend.css) {
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = `/plugins/${plugin.id}/${plugin.frontend.css}`;
      document.head.appendChild(link);
    }

    // 4. Load Plugin JS
    if (plugin.frontend && plugin.frontend.js) {
      const script = document.createElement('script');
      script.src = `/plugins/${plugin.id}/${plugin.frontend.js}`;
      if (plugin.frontend.is_module) script.type = 'module';
      document.body.appendChild(script);
    }
  }
}

document.addEventListener('DOMContentLoaded', () => {
  initDashboard();
  initPlugins();
});
</script>

</body>
</html>
